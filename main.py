# íŒŒì¼ëª…: safetrip_app_v2.py
import streamlit as st
import random
import pandas as pd
from io import StringIO

st.set_page_config(
    page_title="SafeTrip: ì—¬í–‰ ì•ˆì „ ë³´ê³ ì„œ (V2)", 
    page_icon="âœˆï¸", 
    layout="wide" # ë„“ì€ ë ˆì´ì•„ì›ƒ ì‚¬ìš©
)
st.title("âœˆï¸ SafeTrip: ì—¬í–‰ ì•ˆì „ ë³´ê³ ì„œ ë° ì ê²€")
st.markdown("ì—¬í–‰ì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ëª©ë¡ì—ì„œ ì„ íƒí•˜ì—¬ ë§ì¶¤í˜• ì•ˆì „ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
st.markdown("---")

# --- 1. ìƒ˜í”Œ ë°ì´í„° í™•ì¥ ë° êµ¬ì¡°í™” ---
# ì¹˜ì•ˆ, ìì—°ì¬í•´, ì§ˆë³‘/ìœ„ìƒ ë“± ìœ„í—˜ ìš”ì†Œë¥¼ ì„¸ë¶„í™”
safety_data = {
    "ìº„ë³´ë””ì•„": {
        "ìœ„í—˜ ì •ë³´": ["**ì¹˜ì•ˆ**: ì†Œë§¤ì¹˜ê¸° ë° ì ˆë„ ë°œìƒ ì¦ê°€.", "**ì§ˆë³‘**: ë…ê¸°ì—´, ë§ë¼ë¦¬ì•„ ëª¨ê¸° ì£¼ì˜.", "**êµí†µ**: ì˜¤í† ë°”ì´ ì‚¬ê³  ìœ„í—˜ ë†’ìŒ."],
        "ëŒ€ì²˜ ìš”ë ¹": ["ì•¼ê°„ ì™¸ì¶œ ì‹œ íƒì‹œ ì´ìš©.", "ì¥ê¸° ë…¸ì¶œ ì˜· ë° ëª¨ê¸° ê¸°í”¼ì œ ì‚¬ìš©.", "ì—¬ê¶Œì€ ì•ˆì „ê¸ˆê³ ì— ë³´ê´€."],
        "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "117 (ê²½ì°°), 119 (ì•°ë·¸ëŸ°ìŠ¤)", "ëŒ€ì‚¬ê´€": "+855-23-211-937 (í”„ë†ˆíœ)"}
    },
    "ì¼ë³¸": {
        "ìœ„í—˜ ì •ë³´": ["**ìì—°ì¬í•´**: ì§€ì§„ ë° ì“°ë‚˜ë¯¸ ê°€ëŠ¥ì„±.", "**ì¹˜ì•ˆ**: ëŒ€ì²´ë¡œ ì•ˆì „í•˜ë‚˜, ìœ í¥ê°€ í˜¸ê°í–‰ìœ„ ì£¼ì˜.", "**í™˜ê²½**: ì¼ë¶€ ì§€ì—­ ë°©ì‚¬ëŠ¥ ëª¨ë‹ˆí„°ë§ í•„ìš”."],
        "ëŒ€ì²˜ ìš”ë ¹": ["ì§€ì§„ ë°œìƒ ì‹œ 'DROP, COVER, HOLD ON' ê¸°ì–µ.", "ìˆ™ì†Œì˜ ëŒ€í”¼ ê²½ë¡œ ë° ëŒ€í”¼ ì¥ì†Œ í™•ì¸.", "ë¹„ìƒ ì‹ëŸ‰/ë¬¼ ì¤€ë¹„."],
        "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "110 (ê²½ì°°), 119 (êµ¬ê¸‰/ì†Œë°©)", "ëŒ€ì‚¬ê´€": "+81-3-3452-7611 (ë„ì¿„)"}
    },
    "íƒœêµ­": {
        "ìœ„í—˜ ì •ë³´": ["**ì¹˜ì•ˆ**: ê´€ê´‘ì§€ ì†Œë§¤ì¹˜ê¸°, ë°”ê°€ì§€ ìš”ê¸ˆ ì‚¬ê¸° ì£¼ì˜.", "**êµí†µ**: íƒì‹œ ë° íˆ­íˆ­ ì´ìš© ì‹œ ê°€ê²© í¥ì • í•„ìˆ˜.", "**ì§ˆë³‘**: ì‹ì¤‘ë… ë° ìˆ˜ì¸ì„± ì§ˆë³‘ ì£¼ì˜."],
        "ëŒ€ì²˜ ìš”ë ¹": ["ì—¬í–‰ì ë³´í—˜ ê°€ì… í•„ìˆ˜.", "ìŒì‹ì€ ìµí˜€ ë¨¹ê³ , í¬ì¥ëœ ë¬¼ë§Œ ë§ˆì‹œê¸°.", "ì •ë¶€ ê³µì¸ëœ íƒì‹œ ì•± ì‚¬ìš©."],
        "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "191 (ê²½ì°°), 1669 (ì•°ë·¸ëŸ°ìŠ¤)", "ëŒ€ì‚¬ê´€": "+66-2-247-7537~39 (ë°©ì½•)"}
    },
    "ë¯¸êµ­": {
        "ìœ„í—˜ ì •ë³´": ["**ì¹˜ì•ˆ**: ë„ì‹¬ ì¼ë¶€ ì§€ì—­ ë²”ì£„ìœ¨ ë†’ìŒ.", "**ë²•ê·œ**: ì£¼(State)ë³„ ì´ê¸° ì†Œì§€ë²• ë° ë§ˆì•½ ê´€ë ¨ ë²•ê·œ ìƒì´.", "**ìì—°ì¬í•´**: í—ˆë¦¬ì¼€ì¸, í† ë„¤ì´ë„ ë“± ê¸°ìƒ ì´ë³€ ê°€ëŠ¥ì„±."],
        "ëŒ€ì²˜ ìš”ë ¹": ["ì•¼ê°„ì—ëŠ” ì¸ì ì´ ë“œë¬¸ ê³³ í”¼í•˜ê¸°.", "í˜„ì§€ ë¬¸í™” ë° ë²•ê·œ ì‚¬ì „ ìˆ™ì§€.", "ë¹„ìƒ ìƒí™© ì‹œ ì¦‰ì‹œ 911 ì‹ ê³ ."],
        "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "911 (ê²½ì°°/êµ¬ê¸‰/ì†Œë°©)", "ì´ì˜ì‚¬ê´€": "+1-213-385-9300 (LA)"}
    },
    "í•œêµ­": {
        "ìœ„í—˜ ì •ë³´": ["**ì¹˜ì•ˆ**: ëŒ€ì²´ë¡œ ì•ˆì „.", "**êµí†µ**: ì¶œí‡´ê·¼ ì‹œê°„ êµí†µ ì²´ì¦ ìœ ì˜.", "**ê¸°ìƒ**: ì—¬ë¦„ì²  ì¥ë§ˆ/íƒœí’, ê²¨ìš¸ì²  í­ì„¤ ëŒ€ë¹„."],
        "ëŒ€ì²˜ ìš”ë ¹": ["ëŒ€ì¤‘êµí†µ ì´ìš© ê¶Œì¥.", "ë‚ ì”¨ ì •ë³´ ìƒì‹œ í™•ì¸."],
        "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "112 (ê²½ì°°), 119 (êµ¬ê¸‰/ì†Œë°©)", "ì—¬í–‰ì ì•ˆë‚´": "1330"}
    }
}

# ì—¬í–‰ ì „ í•„ìˆ˜ ì ê²€ ë¦¬ìŠ¤íŠ¸
check_list = [
    "ì—¬ê¶Œ/ë¹„ì ìœ íš¨ ê¸°ê°„ í™•ì¸",
    "ì—¬í–‰ì ë³´í—˜ ê°€ì… ì™„ë£Œ",
    "í˜„ì§€ ê¸´ê¸‰ ì—°ë½ì²˜ ì €ì¥",
    "ì‹ ìš©ì¹´ë“œ ë¶„ì‹¤ ì‹ ê³ ì²˜ ë©”ëª¨",
    "ì—¬í–‰ì§€ ë‚ ì”¨ ë° ë³µì¥ í™•ì¸",
    "ìƒë¹„ì•½(í•´ì—´ì œ, ì†Œí™”ì œ ë“±) ì¤€ë¹„"
]

# --- 2. ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ë° ê´€ë¦¬ ---

if "selected_country" not in st.session_state:
    st.session_state.selected_country = "í•œêµ­" # ì´ˆê¸°ê°’ ì„¤ì •
if "search_initiated" not in st.session_state:
    st.session_state.search_initiated = False
if "checklist_status" not in st.session_state:
    # ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ì´ˆê¸°í™”
    st.session_state.checklist_status = {item: False for item in check_list}

# --- 3. ì‚¬ìš©ì ì…ë ¥ ì„¹ì…˜ (ì…ë ¥ ë°©ì‹ ë‹¤ì–‘í™”) ---

col_select, col_input = st.columns(2)

# Selectbox ì…ë ¥
with col_select:
    selected_from_list = st.selectbox(
        "â‘  ëª©ë¡ì—ì„œ ì„ íƒ âœˆï¸", 
        list(safety_data.keys()), 
        index=list(safety_data.keys()).index(st.session_state.selected_country),
        key="country_select"
    )

# Text_input ì…ë ¥
with col_input:
    # ì‚¬ìš©ì ì •ì˜ ì…ë ¥ ê¸°ëŠ¥ ì¶”ê°€
    country_input = st.text_input(
        "â‘¡ ì§ì ‘ êµ­ê°€ ì´ë¦„ ì…ë ¥ (ì˜ˆ: í”„ë‘ìŠ¤, ì´íƒˆë¦¬ì•„)", 
        placeholder="êµ­ê°€ëª… ì…ë ¥ í›„ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­",
        key="country_input"
    )

# ê²€ìƒ‰í•  ìµœì¢… êµ­ê°€ ê²°ì •
final_country = selected_from_list
if country_input and country_input in safety_data:
    final_country = country_input

# --- ë²„íŠ¼ ì„¹ì…˜ ---
col_btn1, col_btn2, col_btn3 = st.columns([1.5, 1, 1])

with col_btn1:
    if st.button("ì•ˆì „ ë³´ê³ ì„œ ê²€ìƒ‰", type="primary", use_container_width=True):
        st.session_state.selected_country = final_country
        st.session_state.search_initiated = True
        st.experimental_rerun()

with col_btn2:
    if st.button("ì´ˆê¸°í™”", use_container_width=True):
        st.session_state.selected_country = "í•œêµ­"
        st.session_state.search_initiated = False
        st.session_state.checklist_status = {item: False for item in check_list}
        st.experimental_rerun()

with col_btn3:
    # ì§€ë„ ê¸°ëŠ¥ì€ Streamlit ìì²´ì—ì„œ êµ¬í˜„ì´ ë³µì¡í•˜ë¯€ë¡œ, ì§€ë„ ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ë”ë¯¸ ë²„íŠ¼ ì œê³µ
    if st.button("ì§€ë„ì—ì„œ ì„ íƒ (êµ¬í˜„ ì˜ˆì •)", disabled=True, use_container_width=True):
         st.info("ì§€ë„ ì„ íƒ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤. ëª©ë¡ì´ë‚˜ ì…ë ¥ì°½ì„ ì´ìš©í•´ ì£¼ì„¸ìš”.")


st.markdown("---")

# --- 4. ì•ˆì „ ë³´ê³ ì„œ ì„¹ì…˜ (Tabsë¡œ ì „ë¬¸í™”) ---

if not st.session_state.search_initiated:
    st.info("ìœ„ì— ì—¬í–‰í•  êµ­ê°€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•œ í›„ 'ì•ˆì „ ë³´ê³ ì„œ ê²€ìƒ‰' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")
else:
    country_info = safety_data.get(st.session_state.selected_country)
    
    if not country_info:
        st.error(f"âŒ **{st.session_state.selected_country}**ì— ëŒ€í•œ ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ ì•ˆì „ ìˆ˜ì¹™ì„ í™•ì¸í•˜ì„¸ìš”.")
        country_info = {"ìœ„í—˜ ì •ë³´": ["ìƒì„¸ ì •ë³´ ì—†ìŒ. ì¼ë°˜ ì•ˆì „ ìˆ˜ì¹™ ì¤€ìˆ˜."], "ëŒ€ì²˜ ìš”ë ¹": ["ì¼ë°˜ ì•ˆì „ ìˆ˜ì¹™ í™•ì¸."], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "í˜„ì§€ ê¸´ê¸‰ ì—°ë½ì²˜ ê²€ìƒ‰ í•„ìš”", "ëŒ€ì‚¬ê´€": "í˜„ì§€ ëŒ€ì‚¬ê´€ ì—°ë½ì²˜ ê²€ìƒ‰ í•„ìš”"}}

    st.header(f"ğŸ” **{st.session_state.selected_country}** ì•ˆì „ ë³´ê³ ì„œ")
    
    # íƒ­ êµ¬ì„± (ì „ë¬¸ì„± ê°•í™”)
    tab1, tab2, tab3, tab4 = st.tabs(["âš ï¸ ìœ„í—˜ ì •ë³´", "âœ… ëŒ€ì²˜ ìš”ë ¹", "ğŸ“ í˜„ì§€ ì—°ë½ì²˜", "ğŸ“ ì—¬í–‰ ì „ ì ê²€"])

    with tab1:
        st.subheader("âš ï¸ ì£¼ìš” ì•ˆì „ ìœ„í—˜ ë° ìœ ì˜ ì‚¬í•­")
        for risk in country_info["ìœ„í—˜ ì •ë³´"]:
            st.warning(f"**{risk}**")
        st.markdown("---")
        st.info("ğŸ’¡ ì—¬í–‰ì§€ë³„ íŠ¹í™”ëœ ìœ„í—˜ ìš”ì†Œë¥¼ ì‚¬ì „ì— ì¸ì§€í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.")

    with tab2:
        st.subheader("âœ… ìœ„í—˜ ìƒí™©ë³„ í–‰ë™ ìš”ë ¹")
        for tip in country_info["ëŒ€ì²˜ ìš”ë ¹"]:
            st.success(f"**{tip}**")
        
        st.markdown("---")
        # ì¼ë°˜ì ì¸ ê¸´ê¸‰ ìƒí™© ëŒ€ì²˜ë²•
        st.markdown("#### ğŸš¨ ì¼ë°˜ ê¸´ê¸‰ ìƒí™© ëŒ€ì²˜ë²•")
        st.markdown("""
        * **ë„ë‚œ/ë¶„ì‹¤:** ì¦‰ì‹œ ê²½ì°° ì‹ ê³  ë° ì˜ì‚¬ê´€ì— ì—°ë½. ì‹ ìš©ì¹´ë“œ ì •ì§€.
        * **ìì—°ì¬í•´:** í˜„ì§€ ì¬ë‚œ ë°©ì†¡ ì²­ì·¨, ëŒ€í”¼ì†Œë¡œ ì´ë™. ì ˆëŒ€ ë‹¹í™©í•˜ì§€ ì•Šê¸°.
        * **ê¸´ê¸‰ ì˜ë£Œ:** ì•°ë·¸ëŸ°ìŠ¤ í˜¸ì¶œ í›„, ë³´í—˜ì‚¬ì— ì—°ë½í•˜ì—¬ ë³‘ì› ì •ë³´ í™•ì¸.
        """)
        
    with tab3:
        st.subheader("ğŸ“ í˜„ì§€ í•„ìˆ˜ ë¹„ìƒ ì—°ë½ë§")
        contact = country_info["í˜„ì§€ ì—°ë½ì²˜"]
        
        st.markdown(f"""
        * **ğŸš¨ í˜„ì§€ ê¸´ê¸‰ ì „í™” (ê²½ì°°/ì†Œë°©/ì•°ë·¸ëŸ°ìŠ¤):** **{contact.get("ê¸´ê¸‰ ì „í™”", "ì •ë³´ ì—†ìŒ")}**
        * **ğŸ‡°ğŸ‡· ì£¼ í˜„ì§€ ëŒ€í•œë¯¼êµ­ ëŒ€ì‚¬ê´€/ì˜ì‚¬ê´€:** **{contact.get("ëŒ€ì‚¬ê´€", "ì •ë³´ ì—†ìŒ")}**
        """)
        st.markdown("---")
        st.info("â˜ï¸ í˜„ì§€ ê¸´ê¸‰ ì „í™”ì™€ ëŒ€ì‚¬ê´€ ë²ˆí˜¸ë¥¼ ì¶œêµ­ ì „ **ë°˜ë“œì‹œ ë©”ëª¨**í•´ ë‘ì„¸ìš”.")

    with tab4:
        st.subheader("ğŸ“ ì—¬í–‰ ì „ í•„ìˆ˜ ì ê²€ ëª©ë¡")
        st.markdown("ì•„ë˜ í•­ëª©ì„ ëª¨ë‘ ì™„ë£Œí•˜ì—¬ ì•ˆì „í•œ ì—¬í–‰ì„ ì¤€ë¹„í•˜ì„¸ìš”.")
        
        # ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ë Œë”ë§ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        new_checklist_status = {}
        for item in check_list:
            # keyë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœê°€ ìœ ì§€ë˜ë„ë¡ í•¨
            is_checked = st.checkbox(item, value=st.session_state.checklist_status[item], key=f"check_{item}")
            new_checklist_status[item] = is_checked

        st.session_state.checklist_status = new_checklist_status
        
        # ì™„ë£Œ ìƒíƒœ í”¼ë“œë°±
        completed_count = sum(st.session_state.checklist_status.values())
        total_count = len(check_list)
        
        st.markdown(f"---")
        if completed_count == total_count:
            st.balloons()
            st.success("ğŸ‰ **ëª¨ë“  ì ê²€ ì™„ë£Œ! ì•ˆì „í•œ ì—¬í–‰ì´ ë  ê±°ì˜ˆìš”!**")
        else:
            st.warning(f"âš ï¸ **{total_count}ê°œ ì¤‘ {completed_count}ê°œ ì™„ë£Œ.** ë‚¨ì€ í•­ëª©ì„ ë§ˆì € ì ê²€í•˜ì„¸ìš”!")

# --- 5. ë§ˆë¬´ë¦¬ ---
st.sidebar.markdown("## ğŸ“š ì•ˆì „ ì—¬í–‰ ê°€ì´ë“œ")
st.sidebar.info("ì—¬í–‰ ì•ˆì „ì€ ì¤€ë¹„ì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤. ì´ ê°€ì´ë“œê°€ ë‹¹ì‹ ì˜ ì—¬í–‰ì„ ë” ì•ˆì „í•˜ê²Œ ì§€ì¼œì¤„ ê±°ì˜ˆìš”.")

st.markdown("---")
st.markdown("Â© 2025 SafeTrip Assistant")
