# íŒŒì¼ëª…: safetrip_app_v7_no_reset.py
import streamlit as st
import random
import pandas as pd

st.set_page_config(
    page_title="SafeTrip: ì—¬í–‰ ì•ˆì „ ë³´ê³ ì„œ (V7)", 
    page_icon="âœˆï¸", 
    layout="wide"
)
st.title("âœˆï¸ SafeTrip: ì—¬í–‰ ì•ˆì „ ë³´ê³ ì„œ ë° ì ê²€ (ìµœì¢… ì•ˆì •í™”)")
st.markdown("ì—¬í–‰í•  **êµ­ê°€**ì™€ **ë„ì‹œ**ë¥¼ ì„ íƒí•˜ê³  **'ì•ˆì „ ë³´ê³ ì„œ ê²€ìƒ‰'** ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§ì¶¤í˜• ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
st.markdown("---")

# --- 1. ìƒ˜í”Œ ë°ì´í„° í™•ì¥ ---
safety_data = {
    "í•œêµ­": {"ë„ì‹œ": ["ì„œìš¸", "ë¶€ì‚°", "ì œì£¼", "ì¸ì²œ", "ëŒ€êµ¬", "ëŒ€ì „", "ê´‘ì£¼", "ìš¸ì‚°"], "ìœ„í—˜ ì •ë³´": ["ì¹˜ì•ˆ: ëŒ€ì²´ë¡œ ì•ˆì „", "êµí†µ: ì¶œí‡´ê·¼ ì‹œê°„ í˜¼ì¡"], "ëŒ€ì²˜ ìš”ë ¹": ["ëŒ€ì¤‘êµí†µ ì´ìš© ê¶Œì¥"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "112 (ê²½ì°°), 119 (êµ¬ê¸‰/ì†Œë°©)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ê²½ë³µê¶", "ë‚¨ì‚°íƒ€ì›Œ"], "ë§›ì§‘": ["ê´‘ì¥ì‹œì¥", "ëª…ë™êµì"], "í•«í”Œ": ["í™ëŒ€", "ì„±ìˆ˜ë™"]}},
    "ì¼ë³¸": {"ë„ì‹œ": ["ë„ì¿„", "ì˜¤ì‚¬ì¹´", "í›„ì¿ ì˜¤ì¹´", "ì‚¿í¬ë¡œ", "ë‚˜ê³ ì•¼", "êµí† ", "ìš”ì½”í•˜ë§ˆ"], "ìœ„í—˜ ì •ë³´": ["ìì—°ì¬í•´: ì§€ì§„ ê°€ëŠ¥ì„±", "ì¹˜ì•ˆ: ìœ í¥ê°€ í˜¸ê°í–‰ìœ„ ì£¼ì˜"], "ëŒ€ì²˜ ìš”ë ¹": ["ì§€ì§„ ë°œìƒ ì‹œ 'DROP, COVER, HOLD ON' ê¸°ì–µ"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "110 (ê²½ì°°), 119 (êµ¬ê¸‰/ì†Œë°©)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["í›„ì§€ì‚°", "ë„ì¿„ íƒ€ì›Œ"], "ë§›ì§‘": ["ë¼ë©˜ ê³¨ëª©", "ì˜¤ì½”ë…¸ë¯¸ì•¼í‚¤"], "í•«í”Œ": ["ì‹œë¶€ì•¼", "ì‹ ì£¼ì¿ "]}},
    "íƒœêµ­": {"ë„ì‹œ": ["ë°©ì½•", "ì¹˜ì•™ë§ˆì´", "í‘¸ì¼“", "íŒŒíƒ€ì•¼", "ë„ë¼ë¹„", "ì½”ì‚¬ë¬´ì´"], "ìœ„í—˜ ì •ë³´": ["ì¹˜ì•ˆ: ê´€ê´‘ì§€ ì†Œë§¤ì¹˜ê¸° ì£¼ì˜", "êµí†µ: íˆ­íˆ­ ì´ìš© ì‹œ ê°€ê²© í¥ì • í•„ìˆ˜"], "ëŒ€ì²˜ ìš”ë ¹": ["ì •ë¶€ ê³µì¸ëœ íƒì‹œ ì•± ì‚¬ìš©"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "191 (ê²½ì°°), 1669 (ì•°ë·¸ëŸ°ìŠ¤)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ì™“ ì•„ë£¬", "ì™•ê¶"], "ë§›ì§‘": ["ì¹´ì˜¤ì‚° ë¡œë“œ ë…¸ì ", "íŒŸíƒ€ì´"], "í•«í”Œ": ["ë£¨í”„íƒ‘ ë°”", "í´ëŸ½"]}},
    "ë² íŠ¸ë‚¨": {"ë„ì‹œ": ["í•˜ë…¸ì´", "í˜¸ì°Œë¯¼", "ë‹¤ë‚­", "ë‚˜íŠ¸ë‘", "í‘¸ê¾¸ì˜¥", "í˜¸ì´ì•ˆ"], "ìœ„í—˜ ì •ë³´": ["êµí†µ: ì˜¤í† ë°”ì´ êµí†µëŸ‰ ë§¤ìš° ë§ìŒ", "ì¹˜ì•ˆ: í•¸ë“œí° ë‚ ì¹˜ê¸° ì£¼ì˜"], "ëŒ€ì²˜ ìš”ë ¹": ["ê¸¸ê±°ë¦¬ ê±¸ì„ ë•Œ ì†Œì§€í’ˆ ë³´í˜¸ ì² ì €"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "113 (ê²½ì°°), 115 (ì•°ë·¸ëŸ°ìŠ¤)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["í•˜ë¡±ë² ì´", "í˜¸ì´ì•ˆ êµ¬ì‹œê°€ì§€"], "ë§›ì§‘": ["ìŒ€êµ­ìˆ˜", "ë°˜ë¯¸"], "í•«í”Œ": ["ì¹´í˜ê±°ë¦¬", "ë¹„ì–´í—"]}},
    "ìº„ë³´ë””ì•„": {"ë„ì‹œ": ["í”„ë†ˆíœ", "ì‹œì— ë¦½", "ì‹œì•„ëˆ„í¬ë¹Œ"], "ìœ„í—˜ ì •ë³´": ["ì¹˜ì•ˆ: ì ˆë„ ë°œìƒ ì¦ê°€", "ì§ˆë³‘: ë…ê¸°ì—´ ëª¨ê¸° ì£¼ì˜"], "ëŒ€ì²˜ ìš”ë ¹": ["ì•¼ê°„ ì™¸ì¶œ ì‹œ íƒì‹œ ì´ìš©"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "117 (ê²½ì°°), 119 (ì•°ë·¸ëŸ°ìŠ¤)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ì•™ì½”ë¥´ì™€íŠ¸"], "ë§›ì§‘": ["ì•„ëª©", "ë¡ë½"], "í•«í”Œ": ["í ìŠ¤íŠ¸ë¦¬íŠ¸"]}},
    "í•„ë¦¬í•€": {"ë„ì‹œ": ["ë§ˆë‹ë¼", "ì„¸ë¶€", "ë³´ë¼ì¹´ì´", "íŒ”ë¼ì™„"], "ìœ„í—˜ ì •ë³´": ["ì¹˜ì•ˆ: í…ŒëŸ¬ ìœ„í—˜ ì§€ì—­ ì¡´ì¬", "ìì—°ì¬í•´: íƒœí’/ì§€ì§„/í™”ì‚° í™œë™ ì£¼ì˜"], "ëŒ€ì²˜ ìš”ë ¹": ["ì™¸êµë¶€ ì—¬í–‰ê²½ë³´ í™•ì¸ í•„ìˆ˜"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "911 (ê²½ì°°/êµ¬ê¸‰/ì†Œë°©)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ì´ˆì½œë¦¿ í"], "ë§›ì§‘": ["ë ˆì´Œ", "í• ë¡œí• ë¡œ"], "í•«í”Œ": ["í™”ì´íŠ¸ ë¹„ì¹˜"]}},
    "ì¸ë„ë„¤ì‹œì•„": {"ë„ì‹œ": ["ìì¹´ë¥´íƒ€", "ë°œë¦¬", "ë¡¬ë³µ", "ìš•ì•¼ì¹´ë¥´íƒ€"], "ìœ„í—˜ ì •ë³´": ["ìì—°ì¬í•´: í™”ì‚° í™œë™ ë° ì“°ë‚˜ë¯¸ ê°€ëŠ¥ì„±", "êµí†µ: ë¬´ë©´í—ˆ ìš´ì „ ìœ„í—˜"], "ëŒ€ì²˜ ìš”ë ¹": ["í˜„ì§€ íƒì‹œ ëŒ€ì‹  ê²€ì¦ëœ êµí†µìˆ˜ë‹¨ ì´ìš©"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "110 (ê²½ì°°), 118 (ì•°ë·¸ëŸ°ìŠ¤)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ìš°ë¶“ ì›ìˆ­ì´ ìˆ²", "ë³´ë¡œë¶€ë‘ë¥´ ì‚¬ì›"], "ë§›ì§‘": ["ë‚˜ì‹œ ê³ ë­"], "í•«í”Œ": ["ìŠ¤ë¯¸ëƒ‘"]}},
    "í˜¸ì£¼": {"ë„ì‹œ": ["ì‹œë“œë‹ˆ", "ë©œë²„ë¥¸", "ë¸Œë¦¬ì¦ˆë²ˆ", "í¼ìŠ¤", "ì• ë“¤ë ˆì´ë“œ"], "ìœ„í—˜ ì •ë³´": ["ìì—°ì¬í•´: ì‚°ë¶ˆ ë° í­ìš°", "í™˜ê²½: ë…ì„± ìƒë¬¼ ì£¼ì˜"], "ëŒ€ì²˜ ìš”ë ¹": ["ì—¬í–‰ ì‹œ ì•¼ìƒë™ë¬¼ê³¼ì˜ ì ‘ì´‰ ìì œ"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "000 (ê²½ì°°/êµ¬ê¸‰/ì†Œë°©)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ì˜¤í˜ë¼ í•˜ìš°ìŠ¤", "ê·¸ë ˆì´íŠ¸ ì˜¤ì…˜ ë¡œë“œ"], "ë§›ì§‘": ["ë¯¸íŠ¸ íŒŒì´"], "í•«í”Œ": ["ë‹¬ë§ í•˜ë²„"]}},
    "ë¯¸êµ­": {"ë„ì‹œ": ["ë‰´ìš•", "LA", "ìƒŒí”„ë€ì‹œìŠ¤ì½”", "ì‹œì¹´ê³ ", "ë§ˆì´ì• ë¯¸", "ë¼ìŠ¤ë² ì´ê±°ìŠ¤", "í•˜ì™€ì´"], "ìœ„í—˜ ì •ë³´": ["ì¹˜ì•ˆ: ë„ì‹¬ ì¼ë¶€ ì§€ì—­ ë²”ì£„ìœ¨ ë†’ìŒ", "ë²•ê·œ: ì´ê¸° ì‚¬ê³  ì£¼ì˜"], "ëŒ€ì²˜ ìš”ë ¹": ["ì•¼ê°„ì—ëŠ” ì¸ì ì´ ë“œë¬¸ ê³³ í”¼í•˜ê¸°"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "911 (ê²½ì°°/êµ¬ê¸‰/ì†Œë°©)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ììœ ì˜ ì—¬ì‹ ìƒ", "ê·¸ëœë“œ ìºë‹ˆì–¸"], "ë§›ì§‘": ["ì¸ì•¤ì•„ì›ƒ ë²„ê±°"], "í•«í”Œ": ["íƒ€ì„ìŠ¤í€˜ì–´"]}},
    "í”„ë‘ìŠ¤": {"ë„ì‹œ": ["íŒŒë¦¬", "ë‹ˆìŠ¤", "ë§ˆë¥´ì„¸ìœ ", "ë¦¬ì˜¹"], "ìœ„í—˜ ì •ë³´": ["ì¹˜ì•ˆ: ê´€ê´‘ì§€ ì†Œë§¤ì¹˜ê¸° ì„±í–‰", "ì‹œìœ„: ë…¸ë™ì¡°í•© ë° ì •ì¹˜ì  ì‹œìœ„ ë¹ˆë²ˆ"], "ëŒ€ì²˜ ìš”ë ¹": ["ì‹œìœ„ êµ¬ì—­ íšŒí”¼"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "17 (ê²½ì°°), 15 (ì•°ë·¸ëŸ°ìŠ¤)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ì—í íƒ‘", "ë£¨ë¸Œë¥´ ë°•ë¬¼ê´€"], "ë§›ì§‘": ["í¬ë£¨ì•„ìƒ", "ë§ˆì¹´ë¡±"], "í•«í”Œ": ["ë§ˆë ˆ ì§€êµ¬"]}},
    "ì´íƒˆë¦¬ì•„": {"ë„ì‹œ": ["ë¡œë§ˆ", "ë°€ë¼ë…¸", "í”¼ë Œì²´", "ë² ë„¤ì¹˜ì•„", "ë‚˜í´ë¦¬"], "ìœ„í—˜ ì •ë³´": ["ì¹˜ì•ˆ: ì§‘ì‹œ ë° ë‹¤ì¤‘ì‹œì„¤ ì†Œë§¤ì¹˜ê¸° ì£¼ì˜", "í™˜ê²½: ê´€ê´‘ì§€ ì£¼ë³€ ì‚¬ê¸°ê¾¼ ì£¼ì˜"], "ëŒ€ì²˜ ìš”ë ¹": ["ê°€ë°©ì€ ëª¸ ì•ìœ¼ë¡œ ë©”ê¸°"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "112 (ê²½ì°°/êµ¬ê¸‰/ì†Œë°©)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ì½œë¡œì„¸ì›€", "ë‘ì˜¤ëª¨ ì„±ë‹¹"], "ë§›ì§‘": ["íŒŒìŠ¤íƒ€", "ì ¤ë¼ë˜"], "í•«í”Œ": ["íŠ¸ë ˆë¹„ ë¶„ìˆ˜"]}},
    "ìŠ¤í˜ì¸": {"ë„ì‹œ": ["ë°”ë¥´ì…€ë¡œë‚˜", "ë§ˆë“œë¦¬ë“œ", "ì„¸ë¹„ì•¼", "ë°œë Œì‹œì•„"], "ìœ„í—˜ ì •ë³´": ["ì¹˜ì•ˆ: ë‹¤ë°œì„± ì†Œë§¤ì¹˜ê¸°", "ë²•ê·œ: ê±°ë¦¬ì—ì„œ í¡ì—° ê·œì œ ì—„ê²©"], "ëŒ€ì²˜ ìš”ë ¹": ["ì§€ì •ëœ í¡ì—° êµ¬ì—­ ì´ìš©"], "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "112 (ê²½ì°°/êµ¬ê¸‰/ì†Œë°©)"}, "ì¶”ì²œ": {"ëª…ì†Œ": ["ì‚¬ê·¸ë¼ë‹¤ íŒŒë°€ë¦¬ì•„", "ì•ŒëŒë¸Œë¼"], "ë§›ì§‘": ["ë¹ ì—ì•¼", "ì¸„ëŸ¬ìŠ¤"], "í•«í”Œ": ["ëŒë¸”ë¼ìŠ¤ ê±°ë¦¬"]}},
}

# ì—¬í–‰ ì „ í•„ìˆ˜ ì ê²€ ë¦¬ìŠ¤íŠ¸
check_list = [
    "ì—¬ê¶Œ/ë¹„ì ìœ íš¨ ê¸°ê°„ í™•ì¸",
    "ì—¬í–‰ì ë³´í—˜ ê°€ì… ì™„ë£Œ",
    "í˜„ì§€ ê¸´ê¸‰ ì—°ë½ì²˜ ì €ì¥",
    "ì‹ ìš©ì¹´ë“œ ë¶„ì‹¤ ì‹ ê³ ì²˜ ë©”ëª¨",
    "ì—¬í–‰ì§€ ë‚ ì”¨ ë° ë³µì¥ í™•ì¸",
    "ìƒë¹„ì•½(í•´ì—´ì œ, ì†Œí™”ì œ ë“±) ì¤€ë¹„"
]

# --- 2. ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ë° ê´€ë¦¬ ---

if "selected_country" not in st.session_state:
    st.session_state.selected_country = "í•œêµ­" 
if "selected_city" not in st.session_state:
    st.session_state.selected_city = "ì„œìš¸"
# 'checklist_status'ë¥¼ êµ­ê°€ë³„ë¡œ ë¶„ë¦¬ ì €ì¥í•˜ëŠ” ë”•ì…”ë„ˆë¦¬ë¡œ ì´ˆê¸°í™”
if "checklist_status" not in st.session_state:
    st.session_state.checklist_status = {} # { "êµ­ê°€ëª…": { "í•­ëª©": False, ... } }
if "report_searched" not in st.session_state:
    st.session_state.report_searched = False
if "balloons_shown" not in st.session_state: # í’ì„  ì œì–´ í”Œë˜ê·¸
    st.session_state.balloons_shown = False


# --- 3. ì‚¬ìš©ì ì…ë ¥ ì„¹ì…˜ (ì„ íƒ í›„ ê²€ìƒ‰ ë°©ì‹) ---

st.subheader("ğŸ“ ì•ˆì „ ë³´ê³ ì„œ ìƒì„±")

col_country, col_city = st.columns(2)

# 1. êµ­ê°€ ì„ íƒ
with col_country:
    def update_city_on_country_change():
        # êµ­ê°€ê°€ ë³€ê²½ë  ë•Œ ë„ì‹œ ì„ íƒê°’ì„ ë¦¬ì…‹
        country_key = st.session_state.country_select
        current_cities = safety_data.get(country_key, {}).get("ë„ì‹œ", [])
        if current_cities:
            st.session_state.selected_city = current_cities[0]
        else:
            st.session_state.selected_city = "ì •ë³´ ì—†ìŒ"
        st.session_state.selected_country = country_key
        st.session_state.report_searched = False # ê²€ìƒ‰ ìƒíƒœ í•´ì œ
        st.session_state.balloons_shown = False # í’ì„  ìƒíƒœ ë¦¬ì…‹

    st.selectbox(
        "â‘  ì—¬í–‰í•  êµ­ê°€ ì„ íƒ ğŸŒ", 
        list(safety_data.keys()), 
        index=list(safety_data.keys()).index(st.session_state.selected_country),
        key="country_select",
        on_change=update_city_on_country_change 
    )

# 2. ë„ì‹œ ì„ íƒ
with col_city:
    current_cities = safety_data.get(st.session_state.selected_country, {}).get("ë„ì‹œ", [])
    
    if st.session_state.selected_city not in current_cities and current_cities:
        st.session_state.selected_city = current_cities[0]
    elif not current_cities:
        st.session_state.selected_city = "ì •ë³´ ì—†ìŒ"

    st.selectbox(
        "â‘¡ ì—¬í–‰í•  ë„ì‹œ ì„ íƒ ğŸ™ï¸",
        current_cities,
        index=current_cities.index(st.session_state.selected_city) if st.session_state.selected_city in current_cities else 0,
        key="city_select",
        on_change=lambda: st.session_state.update(selected_city=st.session_state.city_select, report_searched=False, balloons_shown=False) # ì„ íƒ ì‹œ ê²€ìƒ‰ ìƒíƒœ í•´ì œ ë° í’ì„  ë¦¬ì…‹
    )

col_btn1, col_btn2 = st.columns([1.5, 3])
with col_btn1:
    if st.button("ì•ˆì „ ë³´ê³ ì„œ ê²€ìƒ‰", type="primary", use_container_width=True):
        st.session_state.report_searched = True
        # ê²€ìƒ‰ ì‹œ í˜„ì¬ êµ­ê°€ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        if st.session_state.selected_country not in st.session_state.checklist_status:
            st.session_state.checklist_status[st.session_state.selected_country] = {item: False for item in check_list}
        st.rerun()

st.markdown("---")

# --- 4. ì•ˆì „ ë³´ê³ ì„œ ì„¹ì…˜ (ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ í›„ì—ë§Œ ë‚˜íƒ€ë‚¨) ---

selected_country = st.session_state.selected_country
selected_city = st.session_state.selected_city
country_info = safety_data.get(selected_country)

if st.session_state.report_searched:
    
    if not country_info:
        st.error(f"âŒ **{selected_country}**ì— ëŒ€í•œ ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œ ë‹¤ë¥¸ êµ­ê°€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.")
        country_info = {"ìœ„í—˜ ì •ë³´": ["ìƒì„¸ ì •ë³´ ì—†ìŒ. ì¼ë°˜ ì•ˆì „ ìˆ˜ì¹™ ì¤€ìˆ˜."], 
                        "ëŒ€ì²˜ ìš”ë ¹": ["ì¼ë°˜ ì•ˆì „ ìˆ˜ì¹™ í™•ì¸."], 
                        "í˜„ì§€ ì—°ë½ì²˜": {"ê¸´ê¸‰ ì „í™”": "í˜„ì§€ ê¸´ê¸‰ ì—°ë½ì²˜ ê²€ìƒ‰ í•„ìš”"},
                        "ì¶”ì²œ": {"ëª…ì†Œ": ["ì •ë³´ ì—†ìŒ"], "ë§›ì§‘": ["ì •ë³´ ì—†ìŒ"], "í•«í”Œ": ["ì •ë³´ ì—†ìŒ"]}}

    st.header(f"ğŸ” **{selected_city}, {selected_country}** ì•ˆì „ ë³´ê³ ì„œ")
    
    # í˜„ì¬ êµ­ê°€ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ê°€ì ¸ì˜¤ê¸° 
    current_checklist_status = st.session_state.checklist_status.get(selected_country, {item: False for item in check_list})
    
    # ìƒˆë¡œìš´ íƒ­ ì¶”ê°€
    tab1, tab2, tab3, tab4, tab5 = st.tabs(["âš ï¸ ìœ„í—˜ ì •ë³´", "âœ… ëŒ€ì²˜ ìš”ë ¹", "ğŸ“ í˜„ì§€ ì—°ë½ì²˜", "ğŸ“ ì—¬í–‰ ì „ ì ê²€", "âœ¨ ì¶”ì²œ ëª…ì†Œ/í•«í”Œ"])

    with tab1:
        st.subheader("âš ï¸ ì£¼ìš” ì•ˆì „ ìœ„í—˜ ë° ìœ ì˜ ì‚¬í•­")
        for risk in country_info["ìœ„í—˜ ì •ë³´"]:
            st.warning(f"**{risk}**")
        st.markdown("---")
        
        st.markdown("#### ğŸ“° **í˜„ì§€ ì•ˆì „ ì´ìŠˆ ê²€ìƒ‰**")
        st.info("ğŸ’¡ ìµœê·¼ ë°œìƒí•œ ì‚¬ê³ ë‚˜ ë‰´ìŠ¤ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€ë™ë©ë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ ì´ìš©í•´ ì§ì ‘ í™•ì¸í•´ ë³´ì„¸ìš”.")
        search_query = f"{selected_country} {selected_city} ìµœê·¼ ì•ˆì „ ì‚¬ê³ "
        st.link_button(
            f"êµ¬ê¸€ì—ì„œ '{selected_city} ì•ˆì „ ì‚¬ê³ ' ê²€ìƒ‰í•˜ê¸°", 
            f"https://www.google.com/search?q={search_query}",
            use_container_width=True
        )
        

    with tab2:
        st.subheader("âœ… ìœ„í—˜ ìƒí™©ë³„ í–‰ë™ ìš”ë ¹")
        for tip in country_info["ëŒ€ì²˜ ìš”ë ¹"]:
            st.success(f"**{tip}**")
        
        st.markdown("---")
        st.markdown("#### ğŸš¨ ì¼ë°˜ ê¸´ê¸‰ ìƒí™© ëŒ€ì²˜ë²•")
        st.markdown("""
        * **ë„ë‚œ/ë¶„ì‹¤:** ì¦‰ì‹œ ê²½ì°° ì‹ ê³  ë° ì˜ì‚¬ê´€ì— ì—°ë½. ì‹ ìš©ì¹´ë“œ ì •ì§€.
        * **ìì—°ì¬í•´:** í˜„ì§€ ì¬ë‚œ ë°©ì†¡ ì²­ì·¨, ëŒ€í”¼ì†Œë¡œ ì´ë™.
        """)
        
    with tab3:
        st.subheader("ğŸ“ í˜„ì§€ í•„ìˆ˜ ë¹„ìƒ ì—°ë½ë§ ë° ë©”ëª¨")
        contact = country_info["í˜„ì§€ ì—°ë½ì²˜"]
        
        st.markdown(f"""
        * **ğŸš¨ í˜„ì§€ ê¸´ê¸‰ ì „í™” (ê²½ì°°/ì†Œë°©/ì•°ë·¸ëŸ°ìŠ¤):** **{contact.get("ê¸´ê¸‰ ì „í™”", "ì •ë³´ ì—†ìŒ")}**
        * **ğŸ‡°ğŸ‡· ì£¼ {selected_country} ëŒ€í•œë¯¼êµ­ ëŒ€ì‚¬ê´€/ì˜ì‚¬ê´€:** (ì™¸êµë¶€ ì‚¬ì´íŠ¸ì—ì„œ ì§ì ‘ ê²€ìƒ‰ í›„ ë©”ëª¨í•˜ì„¸ìš”.)
        """)
        
        # í…ìŠ¤íŠ¸ ì—ì–´ë¦¬ì–´ëŠ” ì„¸ì…˜ ìƒíƒœë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë°”ë¡œ í‚¤ë¡œ ê´€ë¦¬
        st.text_area(
            "ëŒ€ì‚¬ê´€/ì˜ì‚¬ê´€ ì—°ë½ì²˜ ë©”ëª¨",
            placeholder="ì˜ˆ: +XX-XXX-XXXX (ì£¼XX ëŒ€ì‚¬ê´€)",
            key=f"embassy_memo_{selected_country}" # êµ­ê°€ë³„ë¡œ ë©”ëª¨ ë¶„ë¦¬
        )
        st.info("â˜ï¸ í˜„ì§€ ëŒ€ì‚¬ê´€ ì—°ë½ì²˜ëŠ” [ì™¸êµë¶€ í•´ì™¸ì•ˆì „ì—¬í–‰](https://www.mofa.go.kr/www/index.do) ì‚¬ì´íŠ¸ì—ì„œ **ì§ì ‘ í™•ì¸** í›„ ë©”ëª¨í•´ ë‘ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.")

    with tab4:
        st.subheader("ğŸ“ ì—¬í–‰ ì „ í•„ìˆ˜ ì ê²€ ëª©ë¡")
        st.markdown("ì•„ë˜ í•­ëª©ì„ ëª¨ë‘ ì™„ë£Œí•˜ì—¬ ì•ˆì „í•œ ì—¬í–‰ì„ ì¤€ë¹„í•˜ì„¸ìš”.")
        
        # ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ë Œë”ë§ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        new_checklist_status = {}
        for item in check_list:
            # í˜„ì¬ êµ­ê°€ì˜ ìƒíƒœë¥¼ ì‚¬ìš©í•˜ì—¬ ì²´í¬ë°•ìŠ¤ë¥¼ í‘œì‹œ
            is_checked = st.checkbox(item, 
                                     value=current_checklist_status.get(item, False), 
                                     key=f"check_{item}_{selected_country}")
            new_checklist_status[item] = is_checked
        
        # ë³€ê²½ëœ ìƒíƒœë¥¼ í˜„ì¬ êµ­ê°€ì˜ ì„¸ì…˜ ìƒíƒœì— ë°˜ì˜
        st.session_state.checklist_status[selected_country] = new_checklist_status
        current_checklist_status = new_checklist_status # ë°˜ì˜ëœ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
        
        # ì™„ë£Œ ìƒíƒœ í”¼ë“œë°±
        completed_count = sum(current_checklist_status.values())
        total_count = len(check_list)
        
        st.markdown(f"---")
        if completed_count == total_count:
            # í’ì„  ì œì–´: ì™„ë£Œ ìƒíƒœì´ê³  ì•„ì§ í’ì„ ì´ ë‚˜ì˜¤ì§€ ì•Šì•˜ë‹¤ë©´ ì‹¤í–‰
            if not st.session_state.balloons_shown:
                st.balloons()
                st.session_state.balloons_shown = True # í’ì„ ì´ ë‚˜ì™”ìŒì„ í‘œì‹œ
            st.success("ğŸ‰ **ëª¨ë“  ì ê²€ ì™„ë£Œ! ì•ˆì „í•œ ì—¬í–‰ì´ ë  ê±°ì˜ˆìš”!**")
        else:
            # ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ í’ì„  ìƒíƒœ ë¦¬ì…‹ (ë‹¤ì‹œ ì²´í¬ í’€ì—ˆì„ ê²½ìš°)
            st.session_state.balloons_shown = False
            st.warning(f"âš ï¸ **{total_count}ê°œ ì¤‘ {completed_count}ê°œ ì™„ë£Œ.** ë‚¨ì€ í•­ëª©ì„ ë§ˆì € ì ê²€í•˜ì„¸ìš”!")
        
        # --- ì²´í¬ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” ë²„íŠ¼ ì œê±°ë¨ ---


    with tab5:
        st.subheader(f"âœ¨ {selected_city} ì¶”ì²œ ëª…ì†Œ, ë§›ì§‘, í•«í”Œ")
        
        rec_data = country_info["ì¶”ì²œ"]
        
        col_m, col_b, col_h = st.columns(3)
        
        with col_m:
            st.info("ğŸ“Œ **ì¶”ì²œ ëª…ì†Œ**")
            for item in rec_data["ëª…ì†Œ"]:
                st.markdown(f"â€¢ {item}")
        
        with col_b:
            st.info("ğŸ½ï¸ **ì¶”ì²œ ë§›ì§‘**")
            for item in rec_data["ë§›ì§‘"]:
                st.markdown(f"â€¢ {item}")
                
        with col_h:
            st.info("ğŸ”¥ **ì¶”ì²œ í•«í”Œë ˆì´ìŠ¤**")
            for item in rec_data["í•«í”Œ"]:
                st.markdown(f"â€¢ {item}")
                
        st.markdown("---")
        st.info("ğŸ’¡ ë” ë§ì€ ì •ë³´ë¥¼ ì›í•˜ì‹œë©´ êµ¬ê¸€ì—ì„œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.")
        search_query_trip = f"{selected_country} {selected_city} ì¶”ì²œ ì—¬í–‰ì§€"
        st.link_button(
            f"êµ¬ê¸€ì—ì„œ '{selected_city} ì¶”ì²œ ëª…ì†Œ' ê²€ìƒ‰í•˜ê¸°", 
            f"https://www.google.com/search?q={search_query_trip}",
            use_container_width=True
        )
    
    # --- 5. ì§€ë„ ì„¹ì…˜ (ê²€ìƒ‰ í›„ì—ë§Œ í‘œì‹œ) ---
    st.markdown("---")
    col_guide, col_map = st.columns(2)

    with col_guide:
        st.markdown("### ğŸ—ºï¸ ì§€ë„ ê¸°ëŠ¥ì— ëŒ€í•˜ì—¬")
        st.info("ìš”ì²­í•˜ì‹  ëŒ€ë¡œ **ì‹¤ì‹œê°„ ì§€ë„** ëŒ€ì‹  **êµ­ê°€ ì´ë¯¸ì§€ ì§€ë„**ë¡œ ëŒ€ì²´í•˜ì˜€ìŠµë‹ˆë‹¤. ì—¬í–‰ì§€ì˜ ì§€ë¦¬ì  ìœ„ì¹˜ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•´ ë³´ì„¸ìš”!")
        
    with col_map:
        st.subheader(f"ğŸŒ {selected_country} ì§€ë¦¬ì  ì •ë³´")
        # ì‹¤ì œ ì´ë¯¸ì§€ë¥¼ ë„£ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ë¡œ ëŒ€ì²´
        st.warning(f"**ğŸš§ ì§€ë¦¬ì  ìœ„ì¹˜ í™•ì¸:** í˜„ì¬ ì„ íƒí•˜ì‹  **{selected_country}**ì˜ ë„ì‹œ **{selected_city}**ëŠ” ì§€ë„ìƒì— [ğŸ“] ìœ„ì¹˜ì— í•´ë‹¹í•©ë‹ˆë‹¤.", icon="ğŸ—ºï¸")
        st.caption("_(Streamlit ì•±ì— ì‹¤ì œ ì§€ë„ë¥¼ í‘œì‹œí•˜ë ¤ë©´ ë³„ë„ì˜ ì´ë¯¸ì§€ íŒŒì¼ì„ ì¤€ë¹„í•˜ê±°ë‚˜, `st.map()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.)_")


# --- 6. ì¶”ì²œ ì—¬í–‰ì§€ ì„¹ì…˜ (ê²€ìƒ‰ ì „, ë©”ì¸ í™”ë©´ì—ë§Œ í‘œì‹œ) ---
if not st.session_state.report_searched:
    st.markdown("---")
    st.subheader("ğŸŒŸ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”! ì¶”ì²œ ì—¬í–‰ì§€ í•«ìŠ¤íŒŸ")
    col_rec1, col_rec2, col_rec3 = st.columns(3)

    # ì¶”ì²œ ë¡œì§ (ì„ì˜ ì§€ì •)
    recommendations = [
        ("ë„ì¿„", "ì¼ë³¸", "ì•ˆì „í•œ ì¹˜ì•ˆ, ì§€ì§„ ëŒ€ë¹„ í•„ìˆ˜!"),
        ("íŒŒë¦¬", "í”„ë‘ìŠ¤", "ì†Œë§¤ì¹˜ê¸° ì£¼ì˜, ë¬¸í™”ì¬ ì¤‘ì‹¬ ê´€ê´‘"),
        ("ë°œë¦¬", "ì¸ë„ë„¤ì‹œì•„", "ìì—°ì¬í•´ ë° êµí†µ í˜¼ì¡ ì£¼ì˜"),
    ]

    for i, (city, country, desc) in enumerate(recommendations):
        col = [col_rec1, col_rec2, col_rec3][i]
        with col:
            st.info(f"**{city} ({country})**", icon="ğŸ“Œ")
            st.caption(desc)
            if st.button(f"'{city}' ì •ë³´ ë°”ë¡œ ë³´ê¸°", key=f"rec_btn_final_{i}", use_container_width=True):
                st.session_state.selected_country = country
                st.session_state.selected_city = city
                st.session_state.report_searched = True
                # ì¶”ì²œ êµ­ê°€/ë„ì‹œ ì„ íƒ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ì´ˆê¸°í™”/ë¶ˆëŸ¬ì˜¤ê¸°
                if country not in st.session_state.checklist_status:
                    st.session_state.checklist_status[country] = {item: False for item in check_list}
                st.rerun()

st.markdown("â€”")
st.markdown("Â© 2025 SafeTrip Assistant")
